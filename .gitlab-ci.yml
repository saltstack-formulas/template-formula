# -*- coding: utf-8 -*-
# vim: ft=yaml
---
###############################################################################
# Define all YAML node anchors
###############################################################################
.node_anchors:
  # `only` (also used for `except` where applicable)
  only_branch_master_parent_repo: &only_branch_master_parent_repo
    - 'master@saltstack-formulas/template-formula'
  # `stage`
  stage_cache: &stage_cache 'cache'
  stage_lint: &stage_lint 'lint'
  stage_release: &stage_release 'release'
  stage_test: &stage_test 'test'
  # `image`
  # yamllint disable rule:line-length
  image_commitlint: &image_commitlint 'techneg/ci-commitlint:v1.1.106@sha256:a280dae44e0a6385234cef49f146b292155270f7d986e0c9cb31885b8618afa5'
  image_dindruby: &image_dindruby 'techneg/ci-docker-python-ruby:v2.2.75@sha256:539377899806b9a992e2c2aaf14e191ec31762f4ac910f64038848d581160d54'
  image_dindrubybionic: &image_dindrubybionic 'techneg/ci-docker-python-ruby:v2.2.75@sha256:539377899806b9a992e2c2aaf14e191ec31762f4ac910f64038848d581160d54'
  image_precommit: &image_precommit 'techneg/ci-pre-commit:v2.5.8@sha256:1fac723b15f757bfe2998916984965e741cce15f94c2abaae305d42342f60974'
  image_rubocop: &image_rubocop 'pipelinecomponents/rubocop:latest@sha256:fe69f9642c7edde46bbd78326d2c42c6e13fc73694efb142e92e206725479328'
  image_semantic-release: &image_semanticrelease 'techneg/ci-semantic-release:v1.2.7@sha256:27fd3b4f502893f8cd68a84539c197d881ee2e78b94720ce1fc7e767d45c6474'
  # `services`
  services_docker_dind: &services_docker_dind
    - 'docker:28.4.0-dind@sha256:831644212c5bdd0b3362b5855c87b980ea39a83c9e9adcef2ce03eced99a737a'
  # yamllint enable rule:line-length
  # `variables`
  # https://forum.gitlab.com/t/gitlab-com-ci-caching-rubygems/5627/3
  # https://bundler.io/v2.3/man/bundle-config.1.html
  variables_bundler: &variables_bundler
    BUNDLE_PATH: '${CI_PROJECT_DIR}/.cache/bundler'
    BUNDLE_DEPLOYMENT: 'true'
  bundle_install: &bundle_install
    - 'bundle version'
    - 'bundle config list'
    # `--no-cache` means don't bother caching the downloaded .gem files
    - 'time bundle install --no-cache'
  cache_bundler: &cache_bundler
    key:
      files:
        - 'Gemfile.lock'
      prefix: 'bundler'
    paths:
      - '${BUNDLE_PATH}'
  # https://pre-commit.com/#gitlab-ci-example
  variables_pre-commit: &variables_pre-commit
    PRE_COMMIT_HOME: '${CI_PROJECT_DIR}/.cache/pre-commit'
  cache_pre-commit: &cache_pre-commit
    key:
      files:
        - '.pre-commit-config.yaml'
      prefix: 'pre-commit'
    paths:
      - '${PRE_COMMIT_HOME}'

###############################################################################
# Define stages and global variables
###############################################################################
stages:
  - *stage_cache
  - *stage_lint
  - *stage_test
  - *stage_release
variables:
  DOCKER_DRIVER: 'overlay2'


###############################################################################
# `cache` stage: build up the bundler cache required before the `test` stage
###############################################################################
build-cache:
  stage: *stage_cache
  image: *image_dindruby
  variables: *variables_bundler
  cache: *cache_bundler
  script: *bundle_install

###############################################################################
# `lint` stage: `commitlint`, `pre-commit` & `rubocop` (latest, failure allowed)
###############################################################################
.lint_job:
  stage: *stage_lint
  needs: []

commitlint:
  extends: '.lint_job'
  image: *image_commitlint
  script:
    # Add `upstream` remote to get access to `upstream/master`
    - 'git remote add upstream
       https://gitlab.com/saltstack-formulas/template-formula.git'
    - 'git fetch --all'
    # Set default commit hashes for `--from` and `--to`
    - 'export COMMITLINT_FROM="$(git merge-base upstream/master HEAD)"'
    - 'export COMMITLINT_TO="${CI_COMMIT_SHA}"'
    # Run `commitlint`
    - 'commitlint --from "${COMMITLINT_FROM}"
                  --to   "${COMMITLINT_TO}"
                  --verbose'

pre-commit:
  extends: '.lint_job'
  image: *image_precommit
  # https://pre-commit.com/#gitlab-ci-example
  variables: *variables_pre-commit
  cache: *cache_pre-commit
  script:
    - 'pre-commit run --all-files --color always --verbose'
    - 'pre-commit run --color always --hook-stage manual commitlint-ci'

# Use a separate job for `rubocop` other than the one potentially run by `pre-commit`
# - The `pre-commit` check will only be available for formulas that pass the default
#   `rubocop` check -- and must continue to do so
# - This job is allowed to fail, so can be used for all formulas
# - Furthermore, this job uses all of the latest `rubocop` features & cops,
#   which will help when upgrading the `rubocop` linter used in `pre-commit`
rubocop:
  extends: '.lint_job'
  allow_failure: true
  image: *image_rubocop
  script:
    - 'rubocop -d -P -S --enable-pending-cops'

###############################################################################
# Define `test` template
###############################################################################
.test_instance: &test_instance
  stage: *stage_test
  image: *image_dindruby
  services: *services_docker_dind
  variables: *variables_bundler
  cache:
    <<: *cache_bundler
    policy: 'pull'
  before_script: *bundle_install
  script:
    # Alternative value to consider: `${CI_JOB_NAME}`
    - 'bin/kitchen verify "${DOCKER_ENV_CI_JOB_NAME}"'

###############################################################################
# Define `test` template (`allow_failure: true`)
###############################################################################
.test_instance_failure_permitted:
  <<: *test_instance
  allow_failure: true
# <REMOVEME

###############################################################################
# Define `test_conversion` template
###############################################################################
.test_conversion:
  stage: *stage_test
  image: *image_dindrubybionic
  services: *services_docker_dind
  variables:
    <<: [*variables_bundler, *variables_pre-commit]
  cache:
    - <<: *cache_bundler
      policy: 'pull'
    - <<: *cache_pre-commit
      policy: 'pull'
  before_script:
    - 'export CONVERTED=test-the-use_this_template-button'
    - 'git clone . /tmp/"${CONVERTED}"-formula'
    - 'cd /tmp/"${CONVERTED}"-formula'
    - 'git config user.email "test@example.com"'
    - 'git config user.name "Test Name"'
    # Install `pre-commit` hooks
    - 'bin/install-hooks'
    # Run the conversion script with debug output
    - 'DEBUG=true bin/convert-formula.sh "${CONVERTED}"'
    - '[ $(git rev-list HEAD --count) -eq 2 ]'
    # Quick visual check that correct files have been updated
    - 'git show --pretty="" --name-status'
    - !reference [.node_anchors, bundle_install]
  script:
    - 'bin/kitchen verify default-debian-11-master'
# REMOVEME>

###############################################################################
# `test` stage: each instance below uses the `test` template above
###############################################################################
## Define the rest of the matrix based on Kitchen testing
# Make sure the instances listed below match up with
# the `platforms` defined in `kitchen.yml`
# <REMOVEME
# NOTE: Please try to select up to six instances that add some meaningful
#       testing of the formula's behaviour. If possible, try to refrain from
#       the classical "chosing all the instances because I want to test on
#       another/all distro/s" trap: it will just add time to the testing (see
#       the discussion on #121).  As an example, the set chosen below covers
#       the most used distros families, systemd and non-systemd and the latest
#       three supported Saltstack versions with python2 and 3.
#       As for `kitchen.yml`, that should still contain all of the platforms,
#       to allow for comprehensive local testing
#       Ref: https://github.com/saltstack-formulas/template-formula/issues/118
#       Ref: https://github.com/saltstack-formulas/template-formula/issues/121
test-formula-conversion: {extends: '.test_conversion'}
# REMOVEME>
# yamllint disable rule:line-length
# Fedora 41+ will permit failure until this PR is merged into kitchen-docker
# https://github.com/test-kitchen/kitchen-docker/pull/427 is merged
# OpenSUSE master branch will fail until zypperpkg module is back in salt core
# https://github.com/saltstack/great-module-migration/issues/14
#
almalinux-9-master: {extends: '.test_instance_failure_permitted'}
almalinux-8-master: {extends: '.test_instance_failure_permitted'}
amazonlinux-2023-master: {extends: '.test_instance_failure_permitted'}
amazonlinux-2-master: {extends: '.test_instance_failure_permitted'}
centos-stream9-master: {extends: '.test_instance_failure_permitted'}
debian-12-master: {extends: '.test_instance_failure_permitted'}
debian-11-master: {extends: '.test_instance_failure_permitted'}
fedora-41-master: {extends: '.test_instance_failure_permitted'}
fedora-40-master: {extends: '.test_instance_failure_permitted'}
opensuse-leap-156-master: {extends: '.test_instance_failure_permitted'}
opensuse-tmbl-latest-master: {extends: '.test_instance_failure_permitted'}
oraclelinux-9-master: {extends: '.test_instance_failure_permitted'}
oraclelinux-8-master: {extends: '.test_instance_failure_permitted'}
rockylinux-9-master: {extends: '.test_instance_failure_permitted'}
rockylinux-8-master: {extends: '.test_instance_failure_permitted'}
ubuntu-2404-master: {extends: '.test_instance_failure_permitted'}
ubuntu-2204-master: {extends: '.test_instance_failure_permitted'}
ubuntu-2004-master: {extends: '.test_instance_failure_permitted'}
almalinux-9-3007-7: {extends: '.test_instance'}
almalinux-8-3007-7: {extends: '.test_instance'}
amazonlinux-2023-3007-7: {extends: '.test_instance'}
amazonlinux-2-3007-7: {extends: '.test_instance_failure_permitted'}
centos-stream9-3007-7: {extends: '.test_instance'}
debian-12-3007-7: {extends: '.test_instance'}
debian-11-3007-7: {extends: '.test_instance'}
fedora-41-3007-7: {extends: '.test_instance_failure_permitted'}
fedora-40-3007-7: {extends: '.test_instance'}
opensuse-leap-156-3007-7: {extends: '.test_instance'}
opensuse-tmbl-latest-3007-7: {extends: '.test_instance'}
oraclelinux-9-3007-7: {extends: '.test_instance'}
oraclelinux-8-3007-7: {extends: '.test_instance'}
rockylinux-9-3007-7: {extends: '.test_instance'}
rockylinux-8-3007-7: {extends: '.test_instance'}
ubuntu-2404-3007-7: {extends: '.test_instance'}
ubuntu-2204-3007-7: {extends: '.test_instance'}
ubuntu-2004-3007-7: {extends: '.test_instance'}
almalinux-9-3006-15: {extends: '.test_instance'}
almalinux-8-3006-15: {extends: '.test_instance'}
amazonlinux-2023-3006-15: {extends: '.test_instance'}
amazonlinux-2-3006-15: {extends: '.test_instance_failure_permitted'}
centos-stream9-3006-15: {extends: '.test_instance'}
debian-12-3006-15: {extends: '.test_instance'}
debian-11-3006-15: {extends: '.test_instance'}
fedora-41-3006-15: {extends: '.test_instance_failure_permitted'}
fedora-40-3006-15: {extends: '.test_instance'}
opensuse-leap-156-3006-15: {extends: '.test_instance'}
opensuse-tmbl-latest-3006-15: {extends: '.test_instance'}
oraclelinux-9-3006-15: {extends: '.test_instance'}
oraclelinux-8-3006-15: {extends: '.test_instance'}
rockylinux-9-3006-15: {extends: '.test_instance'}
rockylinux-8-3006-15: {extends: '.test_instance'}
ubuntu-2404-3006-15: {extends: '.test_instance'}
ubuntu-2204-3006-15: {extends: '.test_instance'}
ubuntu-2004-3006-15: {extends: '.test_instance'}
# yamllint enable rule:line-length

###############################################################################
# `release` stage: `semantic-release`
###############################################################################
semantic-release:
  stage: *stage_release
  image: *image_semanticrelease
  variables:
    MAINTAINER_TOKEN: '${GH_TOKEN}'
  script:
    # Run `semantic-release`
    - 'semantic-release'
